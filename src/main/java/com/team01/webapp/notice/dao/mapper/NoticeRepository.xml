<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team01.webapp.notice.dao.INoticeRepository">
	
	<!-- 전체 공지사항 행수 
		 @author : 황건희
	-->
	<select id="selectTotalNoticeListCount" resultType="int">
		SELECT COUNT(*) FROM NOTICE
	</select>
	
	<!-- 게시글 목록 
		@author : 황건희
	-->
	<select id="selectNoticeList" parameterType="pager" resultType="notice">
		<![CDATA[
			SELECT 
			    RNUM AS "seq",
			    NTC_NO AS "ntcNo",
			    USER_ID AS "userId",
			    NTC_TTL AS "ntcTtl",
			    NTC_INQ_CNT AS "ntcInqCnt",
			    NTC_WRT_DATE AS "ntcWrtDate"
			FROM(
			    SELECT 
			        NTC_NO,
			        NTC_TTL,
			        NTC_INQ_CNT,
			        NTC_WRT_DATE,
			        NTC_PRY,
			        USER_ID,
			        ROWNUM as RNUM

			    FROM(
			        SELECT 
			            n.NTC_NO,
			            n.NTC_TTL,
			            n.NTC_INQ_CNT,
			            n.NTC_WRT_DATE,
			            n.NTC_PRY,
			            u.USER_ID
			        FROM NOTICE n, USERS u
			        WHERE n.user_no = u.user_no
			        ORDER BY n.ntc_pry desc
			    )
			    WHERE ROWNUM <=#{endRowNo}
			)
			WHERE rnum >=#{startRowNo}
		]]>
	</select>
	
	<!-- 게시글 작성
		@author : 황건희
	 -->
	<insert id="insertNoticeWrite" parameterType="notice">
		<selectKey keyProperty="ntcNo" resultType="int" order="BEFORE">
			SELECT ntcno_seq.nextval FROM dual
		</selectKey>
		<![CDATA[
			INSERT INTO NOTICE( NTC_NO, USER_NO, NTC_TTL, NTC_CN, NTC_INQ_CNT, NTC_WRT_DATE, NTC_PRY)
			VALUES( ntcno_seq.nextval, #{userNo}, #{ntcTtl}, #{ntcCn}, 0, sysdate, #{ntcPry} )
		]]>
		
	</insert>
	
	<!-- 첨부파일 
		 @author : 황건희
	-->
	<insert id="insertNoticeFileUpload" parameterType="noticeFile">
		<![CDATA[
			INSERT INTO NTC_FILE( NTC_FILE_NO, NTC_NO, NTC_FILE_PHYS_NM, NTC_FILE_ACTL_NM, NTC_FILE_EXTN_NM)
			VALUES(ntcFileNo_seq.nextval, #{ntcNo}+1, #{ntcFilePhysNm}, #{ntcFileActlNm}, #{ntcFileExtnNm})
		]]>
	</insert>
	

	<!-- 게시글 상세조회 
		@author : 황건희	
	-->
	<select id="selectNoticeDetail" parameterType="int" resultType="notice">
		SELECT 
		    n.NTC_TTL AS ntcTtl,
		    n.NTC_NO AS ntcNo,
		    u.USER_ID AS userId,
		    n.NTC_INQ_CNT AS ntcInqCnt,
		    n.NTC_WRT_DATE AS ntcWrtDate,
		    n.NTC_CN AS ntcCn,
		    nf.NTC_FILE_ACTL_NM AS ntcFileActlNm,
		    nf.NTC_FILE_PHYS_NM AS ntcFilePhysNm,
		    nf.NTC_FILE_EXTN_NM AS ntcFileExtnNm
		FROM NOTICE n
		LEFT OUTER JOIN NTC_FILE nf
		ON n.NTC_NO = nf.NTC_NO
		LEFT OUTER JOIN USERS u
		ON n.USER_NO = u.USER_NO
		WHERE n.NTC_NO = #{ntcNo}
	</select>
	
	<!-- 게시글 조회수
		@author : 황건희	
	 -->
	<update id="selectInqCnt" parameterType="int">
		UPDATE NOTICE
		SET NTC_INQ_CNT = NTC_INQ_CNT+1
		WHERE NTC_NO = #{ntcNo} 
		
	</update>
	
	<!-- 게시글 수정 
		@author : 황건희	
	-->
	<update id="updateNotice" parameterType="notice">
		UPDATE NOTICE
		SET NTC_CN = #{ntcCn}
		WHERE NTC_NO = #{ntcNo}
	</update>
	
	<!-- 게시글 삭제 
		@author : 황건희	
	-->
	<delete id="delete" parameterType="int">
		DELETE FROM NOTICE
		WHERE NTC_NO = #{ntcNo}
	</delete>
	
	<!-- 첨부파일 수정
		@author : 황건희	
	 -->
	<update id="updateFile" parameterType="noticeFile">
		UPDATE NTC_FILE
		SET 
			NTC_FILE_ACTL_NM = #{ntcFileActlNm},
			NTC_FILE_PHYS_NM = #{ntcFilePhysNm},
			NTC_FILE_EXTN_NM = #{ntcFileExtnNm}
		WHERE NTC_NO = #{ntcNo}
			
	</update>	
	
	<!-- DB의 최신 첨부파일 No 
		@author : 황건희	
	-->
	<select id="selectMaxFileNo" resultType="int">
		SELECT COUNT(*) FROM NTC_FILE
	</select>
	
	<insert id="updateNoticeFileUpload" parameterType="noticeFile">
		<![CDATA[
			INSERT INTO NTC_FILE( NTC_FILE_NO, NTC_NO, NTC_FILE_PHYS_NM, NTC_FILE_ACTL_NM, NTC_FILE_EXTN_NM)
			VALUES(#{ntcFileNo}, #{ntcNo}, #{ntcFilePhysNm}, #{ntcFileActlNm}, #{ntcFileExtnNm})
		]]>
	</insert>
	
	
</mapper>
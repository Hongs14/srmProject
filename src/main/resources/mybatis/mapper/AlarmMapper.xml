<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team01.webapp.alarm.dao.IAlarmRepository">
	
	<!-- 읽지 않은 알림 수 -->
	<select id="selectAlarmCount" parameterType="alarm" resultType="int">
		SELECT COUNT(ALARM_NO)
		FROM SR_ALARM sa, SR s, USERS u
		WHERE sa.SR_NO = s.SR_NO
		AND u.USER_NO = sa.USER_NO
		AND sa.SR_NO like #{sysNo}
		<if test="userType.equals('고객사')">
			AND sa.USER_NO = #{userNo}
		</if>
		<if test="userType.equals('관리자')">
			AND s.STTS_NO = 1
		</if>
		AND MESSAGE_CHECK = 'N'
	</select>
	
	<!-- 전체 알림 리스트 -->
	<select id="selectAlarmList" parameterType="int" resultType="alarm">
		SELECT 
		    sa.ALARM_NO AS "alarmNo",
		    u.USER_NO AS "userNo",
		    sa.MESSAGE AS "message",
		    sa.MESSAGE_CHECK AS "messageCheck",
		    sa.MESSAGE_DATE AS "messageDate",
		    sa.ALARM_PRY AS "alarmPry",
		    sa.ALARM_TTL AS "alarmTtl",
		    sa.ALARM_CATEGORY AS "alarmCategory",
		    sa.SR_NO AS "srNo"
		FROM SR_ALARM sa, SR s, USERS u
		WHERE sa.SR_NO = s.SR_NO
		AND u.USER_NO = sa.USER_NO
		AND sa.SR_NO like #{sysNo}
		<if test="userType.equals('고객사')">
			AND sa.USER_NO = #{userNo}
		</if>
		<if test="userType.equals('관리자')">
			AND s.STTS_NO = 1
		</if>
		ORDER BY MESSAGE_CHECK, MESSAGE_DATE DESC
	</select>
	
	<!-- 해당 SR 고객사 찾기 -->
	<select id="selectAlarm" parameterType="String" resultType="alarm">
		SELECT
			s.SR_NO AS "srNo",
			s.SR_CUST_NO AS "userNo",
			st.STTS_NM AS "sttsNm",
			s.SR_TTL AS "srTtl"
		FROM SR s, SR_STTS st
		WHERE s.STTS_NO = st.STTS_NO
		AND s.SR_NO = #{srNo}
	</select>
	
	<insert id="insertAlarm" parameterType="alarm">
		<if test="sttsNm.equals('요청')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 요청이 등록 되었습니다.','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
		<if test="sttsNm.equals('검토중')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 요청이 검토중 입니다.','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
		<if test="sttsNm.equals('접수')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 요청이 정상적으로 접수 되었습니다.','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
		<if test="sttsNm.equals('완료요청')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 완료 요청 승인 바랍니다.','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
		<if test="sttsNm.equals('개발완료')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 요청이 개발완료 되었습니다..','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
		<if test="sttsNm.equals('반려')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 요청이 반려 되었습니다.','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
		<if test="sttsNm.equals('재검토')">
			INSERT INTO SR_ALARM( ALARM_NO, USER_NO, MESSAGE, MESSAGE_CHECK, MESSAGE_DATE, ALARM_PRY, ALARM_TTL, SR_NO, ALARM_CATEGORY)
			VALUES(alarmno_seq.nextval,#{userNo},'SR 요청이 재검토 되었습니다.','N',sysdate,'하', #{srTtl}, #{srNo},'SR상태변경')
		</if>
	</insert>
	
	<!-- 알림 체크 -->
	<update id="updateAlarmCheck" parameterType="String">
		UPDATE SR_ALARM 
		SET MESSAGE_CHECK = 'Y'
		WHERE SR_NO = #{srNo}
	</update>
	
	<!-- 알릭 삭제 -->
	<delete id="deleteAlarm" parameterType="int">
		DELETE FROM SR_ALARM
		WHERE ALARM_NO = #{alarmNo}
	</delete>
	
	<!-- 로그인한 유저 정보 가져오기 -->
	<select id="selectLoginUser" parameterType="int" resultType="users">
		SELECT 
		    SYS_NM AS "sysNm",
    		sys.SYS_NO AS "sysNo"
		FROM USERS u, SYSTEM sys
		WHERE u.USER_NO = sys.MANAGER_NO
		AND u.USER_NO = #{userNo}
	</select>
	
</mapper>